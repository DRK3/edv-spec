<!DOCTYPE html>
<html>
  <head>
    <title>Secure Data Hubs 0.1</title>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'/>
    <!--
      === NOTA BENE ===
      For the three scripts below, if your spec resides on dev.w3 you can check them
      out in the same tree and use relative links so that they'll work offline,
     -->
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class='remove'></script>
    <script src="./common.js" class="remove"></script>
    <script type="text/javascript" class="remove">
      var respecConfig = {
        // specification status (e.g., WD, LCWD, NOTE, etc.). If in doubt use ED.
        specStatus: "CG-DRAFT",

        // the specification's short name, as in http://www.w3.org/TR/short-name/
        shortName: "data-hubs",

        // subtitle for the spec
        subtitle: "Encrypted storage for the Web",

        // if you wish the publication date to be other than today, set this
        //publishDate: "2019-03-26",
        //crEnd: "2019-04-23",
        //implementationReportURI: "https://w3c.github.io/sdh-test-suite",
        //previousMaturity: "CG-DRAFT",
        //previousPublishDate: "2019-02-08",

        // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
        // and its maturity status
        // previousPublishDate:  "1977-03-15",
        // previousMaturity:  "WD",

        // extend the bibliography entries
        localBiblio: ccg.localBiblio,
        doJsonLd: true,

        github: "https://github.com/w3c-ccg/data-hubs/",
        includePermalinks: false,

        // if there a publicly available Editor's Draft, this is the link
        edDraftURI: "https://w3c-ccg.github.io/data-hubs/",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",

        // editors, add as many as you like
        // only "name" is required
        editors: [
          { name: "Manu Sporny", url: "http://manu.sporny.org/",
            company: "Digital Bazaar", companyURL: "http://digitalbazaar.com/"},
          { name: "Dave Longley", url: "https://github.com/dlongley",
            company: "Digital Bazaar", companyURL: "http://digitalbazaar.com/"}
        ],
        // authors, add as many as you like.
        // This is optional, uncomment if you have authors as well as editors.
        // only "name" is required. Same format as editors.
        authors:
        [
          { name: "Dave Longley", url: "http://digitalbazaar.com/",
            company: "Digital Bazaar", companyURL: "http://digitalbazaar.com/"},
          { name: "Manu Sporny", url: "http://digitalbazaar.com/",
            company: "Digital Bazaar", companyURL: "http://digitalbazaar.com/" }
        ],
        // name of the WG
        wg:           "Credentials Community Group",

        // URI of the public WG page
        wgURI:        "https://www.w3.org/community/credentials/",

        // name (with the @w3c.org) of the public mailing to which comments are due
        wgPublicList: "public-credentials",

        // URI of the patent status for this WG, for Rec-track documents
        // !!!! IMPORTANT !!!!
        // This is important for Rec-track documents, do not copy a patent URI from a random
        // document unless you know what you're doing. If in doubt ask your friendly neighborhood
        // Team Contact.
        wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/98922/status",
        maxTocLevel: 2,
        inlineCSS: true
      };
    </script>
    <style>
pre .highlight {
  font-weight: bold;
  color: green;
}
pre .comment {
  font-weight: bold;
  color: Gray;
}
.color-text {
  font-weight: bold;
  text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
}
    </style>
  </head>
  <body>
    <section id='abstract'>
      <p>
We store a significant amount of sensitive data online such as personally
identifying information, trade secrets, family pictures, and customer
information. The data that we store should be encrypted in transit and at rest
but is often not protected in an appropriate manner.
This specification describes a privacy-respecting mechanism for storing,
indexing, and retrieving encrypted data at a storage provider. It is often
useful when an individual or organization wants to protect data in a way that
the storage provider cannot view, analyze, aggregate, or resell the data.
This approach also ensures that application data is portable and protected
from storage provider data breaches.
      </p>
    </section>

    <section id='sotd'>
      <p>
Comments regarding all aspects of this document are welcome.
Please file issues
directly on <a href="https://github.com/w3c-ccg/data-hubs/issues/">GitHub</a>,
or send them to
<a href="mailto:public-credentials@w3.org">public-credentials@w3.org</a>
(<a href="mailto:public-credentials-request@w3.org?subject=subscribe">subscribe</a>,
<a href="https://lists.w3.org/Archives/Public/public-credentials/">archives</a>).
      </p>

    </section>

    <section class="informative">
      <h2>Introduction</h2>

      <p>
We store a significant amount of sensitive data online such as personally
identifying information, trade secrets, family pictures, and customer
information. The data that we store should be encrypted in transit and at rest
but is often not protected in an appropriate manner.
This specification describes a privacy-respecting mechanism for storing,
indexing, and retrieving encrypted data at a storage provider. It is often
useful when an individual or organization wants to protect data in a way that
the storage provider cannot view, analyze, aggregate, or resell the data.
This approach also ensures that application data is portable and protected
from storage provider data breaches.
      </p>

      <section class="informative">
        <h3>Why Do We Need Secure Data Hubs?</h3>

        <p class="issue">
Explain why individuals and organizations that want to protect their privacy,
trade secrets, and ensure data portability will benefit from using this
technology.
        </p>
      </section>

      <section class="informative">
        <h3>Ecosystem Overview</h3>

        <p>
This section describes the roles of the core actors and the relationships
between them in an ecosystem where this specification is expected
to be useful. A role is an abstraction that might be implemented in many
different ways. The separation of roles suggests likely interfaces and
protocols for standardization. The following roles are introduced in this
specification:
        </p>

        <dl>
          <dt>storage agent</dt>
          <dd>
A role an <a>entity</a> might perform by
          </dd>
          <dt>storage provider</dt>
          <dd>
A role an <a>entity</a> might perform by
          </dd>
        </dl>

      </section>

      <section class="informative">
        <h3>Use Cases and Requirements</h3>

        <p>
The USE-CASES document outlines a number
of key topics that readers might find useful, including:
        </p>

        <ul>
          <li>
TBD
          </li>
        </ul>

        <p>
As a result of documenting and analyzing the use cases document, the following
desirable ecosystem characteristics were identified for this specification:
        </p>
<!-- requirement list start -->
        <ul>
          <li>
TBD
          </li>
      </section>

      <section id="conformance" class="normative">
        <p>
TBD
        </p>
      </section>

    </section>

    <section class="informative">
      <h2>Terminology</h2>

      <div data-include="./terms.html"
        data-oninclude="restrictReferences">
      </div>
    </section>

    <section class="informative">
      <h2>Core Concepts</h2>

      <p>
The following sections outline core concepts, such as ...
which form the foundation of this specification.
      </p>

      <section class="normative">
        <h2>Encrypted Storage</h2>

        <p class="issue">
Explain why storing data encrypted at rest is a good idea and how you can
control who has access to what data in a more fine grained way by doing this.
        </p>
      </section>

      <section class="normative">
        <h2>Structured Documents</h2>

        <p>
The fundamental unit of storage in data hubs is the encrypted
structured document which, when decrypted, provides a data structure that
can be expressed in popular syntaxes such as JSON and CBOR. Documents can
store structured data and metadata about the structured data. Structured
document sizes are limited to 16MB.
        </p>
      </section>

      <section class="normative">
        <h2>Streams</h2>

        <p>
For files larger than 16MB or for raw binary data formats such as audio,
video, and office productivity files, a streaming API is provided that
enables data to be streamed to/from a data hub. Streams are described using
structured documents, but the storage of the data is separated from the
structured document using a hashlink to the encrypted content.
        </p>
      </section>

      <section class="normative">
        <h2>Indexing</h2>

        <p>
Data hubs are expected to store a very large number of documents
of varying kinds. This means that it is important to be able to search the
documents in a timely way, which creates a challenge for the storage provider
as the content is encrypted. An encrypted search scheme is provided for
secure data hubs that enable data hub clients to do meta data indexing while
not leaking metadata to the storage provider.
        </p>
      </section>

    </section>

    <section class="informative">
      <h2>Data Model</h2>

      <p>
The following sections outlines the data model for data hubs.
      </p>

      <section>
        <h3>DataHubConfiguration</h3>

        <p>
A data hub configuration specifies the properties a particular data hub
will have.
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">Property</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>sequence</td>
              <td>
A unique counter for the data hub in order to ensure that
clients are properly synchronized to the data hub. The value is required and
MUST be an unsigned 64-bit number.
              </td>
            </tr>
            <tr>
              <td>controller</td>
              <td>
The entity or cryptographic key that is in control of the
data hub. The value is required and MUST be a URI.
              </td>
            </tr>
            <tr>
              <td>referenceId</td>
              <td>
Used to express an application-specific reference identifier. The value is
optional and, if present, MUST be a URI.
              </td>
            </tr>
            <tr>
              <td>kek.id</td>
              <td>
An identifier for the key encryption key. The value is required and MUST be
a URI.
              </td>
            </tr>
            <tr>
              <td>kek.type</td>
              <td>
The type of key encryption key. The value is required and MUST be or map to
a URI.
              </td>
            </tr>
            <tr>
              <td>hmac.id</td>
              <td>
An identifier for the HMAC key. The value is required a MUST be or map to a URI.
              </td>
            </tr>
            <tr>
              <td>hmac.type</td>
              <td>
The type of HMAC key. The value is required and MUST be or map to
a URI.
              </td>
            </tr>
          </tbody>
        </table>

        <pre class="example highlight" title="Example data hub configuration">
{
  sequence: 0,
  controller: "did:example:123456789",
  referenceId: "urn:uuid:abc5a436-21f9-4b4c-857d-1f5569b2600d",
  kek: {
    id: "https://example.com/kms/12345",
    type: "AesKeyWrappingKey2019"
  },
  hmac: {
    id: "https://example.com/kms/67891",
    type: "Sha256HmacKey2019"
  }
}
        </pre>

      </section>

      <section>
        <h3><dfn>StructuredDocument</dfn></h3>

        <p>
A structured document is used to store application data as well as metadata
about the application data. This information is typically encrypted and then
stored on the data hub.
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">Property</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>id</td>
              <td>
An identifier for the structured document. The value is required and MUST be a
URI.
              </td>
            </tr>
            <tr>
              <td>meta</td>
              <td>
Key-value metadata associated with the structured document.
              </td>
            </tr>
            <tr>
              <td>content</td>
              <td>
Key-value content for the structured document.
              </td>
            </tr>
          </tbody>
        </table>

        <pre class="example highlight" title="Example structured document">
{
  "id": "urn:uuid:94684128-c42c-4b28-adb0-aec77bf76044",
  meta: {
    "created": "2019-06-18"
  },
  content: {
    "message": "Hello World!"
  }
}
        </pre>

      </section>

      <section>
        <h3><dfn>EncryptedDocument</dfn></h3>

        <p>
An encrypted document is used to store a structured document in a way that
ensures that no entity can read the information without the consent of the
data controller.
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">Property</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>id</td>
              <td>
An identifier for the encrypted document. The value is required and MUST be a
URI.
              </td>
            </tr>
            <tr>
              <td>sequence</td>
              <td>
A unique counter for the data hub in order to ensure that
clients are properly synchronized to the data hub. The value is required and
MUST be an unsigned 64-bit number.
              </td>
            </tr>
            <tr>
              <td>jwe or cwe</td>
              <td>
A JSON Web Encryption or COSE Encrypted value that, if decoded, results in
the corresponding <a>StructuredDocument</a>.
              </td>
            </tr>
          </tbody>
        </table>

        <pre class="example highlight" title="Example encrypted document">
{
  "id": "urn:uuid:94684128-c42c-4b28-adb0-aec77bf76044",
  "sequence": 0,
  "jwe": {
    "protected": "eyJlbmMiOiJDMjBQIn0",
    "recipients": [{
      "header": {
        "alg": "A256KW",
        "kid": "https://example.com/kms/f3ce1a43-162f-43b2-80b4-b51abbeea46e"
      },
      "encrypted_key": "OR1vdCNvf_B68mfUxFQVT-vyXVrBembuiM40mAAjDC1-Qu5iArDbug"
    }],
    "iv": "i8Nins2vTI3PlrYW",
    "ciphertext": "Cb-963UCXblINT8F6MDHzMJN9EAhK3I",
    "tag": "pfZO0JulJcrc3trOZy8rjA"
  }
}
        </pre>

      </section>

    </section>

    <section class="normative">
      <h2>Data Hub HTTPS API</h2>

      <p>
This section introduces some basic concepts for the specification...
      </p>

      <section>
        <h3>Discovering Service Endpoints</h3>

        <p>
A website may provide service endpoint discovery by embedding JSON-LD in their
top-most HTML web page (e.g. at <code>https://example.com/</code>):
        </p>

        <pre class="example highlight" title="Example of HTML-based service description">
&lt;!DOCTYPE html>
&lt;html lang="en">
  &lt;head>
    &lt;meta charset="utf-8">
    &lt;title>Example Website&lt;/title>
    &lt;link rel="stylesheet" href="style.css">
    &lt;script src="script.js">&lt;/script>
    &lt;script type="application/json">
{
  "@context": "https://w3id.org/data-hubs/v1",
  "id": "https://example.com/",
  "name": "Example Website",
  "dataHubCreationService": "https://example.com/data-hubs"
  "dataHubQueryService": "https://example.com/data-hubs"
}
    &lt;/script>
  &lt;/head>
  &lt;body>
    &lt;!-- page content -->
  &lt;/body>
&lt;/html>
        </pre>

        <p>
Service descriptions may also be requested via content negotiation.
In the following example a JSON-compatible service description is provided
(e.g. <code>curl -H "Accept: application/json" https://example.com/</code>):
        </p>

        <pre class="example highlight" title="Example of a JSON-based service description">
{
  "@context": "https://w3id.org/data-hubs/v1",
  "id": "https://example.com/",
  "name": "Example Website",
  "dataHubCreationService": "https://example.com/data-hubs"
}
        </pre>

      </section>

      <section class="normative">
        <h2>Creating a Data Hub</h2>

        <p>
A data hub is created by performing an HTTP POST of a
<a href="#datahubconfiguration">DataHubConfiguration</a>
to the <code>dataHubCreationService</code>. The following HTTP
status codes are defined for this service:
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">HTTP Status</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>201</td>
              <td>
Data hub creation was successful. The HTTP <code>Location</code> header will
contain the URL for the newly created data hub.
              </td>
            </tr>
            <tr>
              <td>400</td>
              <td>
Data hub creation failed.
              </td>
            <tr>
            </tr>
              <td>409</td>
              <td>
A duplicate data hub exists.
              </td>
            </tr>
          </tbody>
        </table>

        <p>
An example exchange of a data hub creation is shown below:
        </p>

        <pre class="example highlight" title="Data hub creation request">
POST /data-hubs HTTP/1.1
Host: example.com
Content-Type: application/json
Accept: application/json, text/plain, */*
Accept-Encoding: gzip, deflate

{
  sequence: 0,
  controller: "did:example:123456789",
  referenceId: "urn:uuid:abc5a436-21f9-4b4c-857d-1f5569b2600d",
  kek: {
    id: "https://example.com/kms/12345",
    type: "AesKeyWrappingKey2019"
  },
  hmac: {
    id: "https://example.com/kms/67891",
    type: "Sha256HmacKey2019"
  }
}
        </pre>

        <p>
If the creation of the data hub was successful, an HTTP 201 status code is
expected in return:
        </p>

        <pre class="example highlight" title="Successful data hub creation response">
HTTP/1.1 201 Created
Location: https://example.com/data-hubs/ad800444
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
Date: Fri, 14 Jun 2019 18:35:33 GMT
Connection: keep-alive
Transfer-Encoding: chunked
        </pre>

      </section>

      <section class="normative">
        <h2>Creating a Document</h2>

        <p>
A structured document is stored in a data hub by encoding a
<a>StructuredDocument</a> as an <a>EncryptedDocument</a> and then performing
an HTTP POST to a data hub endpoint created via the
<a>Creating a Data Hub</a> section.
The following HTTP status codes are defined for this service:
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">HTTP Status</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>201</td>
              <td>
Structured document creation was successful. The HTTP <code>Location</code>
header will contain the URL for the newly created document.
              </td>
            </tr>
            <tr>
              <td>400</td>
              <td>
Structured document creation failed.
              </td>
            </tr>
          </tbody>
        </table>

        <p>
In order to convert a <a>StructuredDocument</a> to an
<a>EncryptedDocument</a> an implementer MUST encode the
<a>StructuredDocument</a> as a JWE or a COSE Encrypted object. Once the
document is encrypted, it can be sent to the document creation service.
        </p>

        <p>
A protocol example of a document creation is shown below:
        </p>

        <pre class="example highlight" title="Data hub creation request">
POST /data-hubs/ad800444 HTTP/1.1
Host: example.com
Content-Type: application/json
Accept: application/json, text/plain, */*
Accept-Encoding: gzip, deflate

{
  "id": "urn:uuid:94684128-c42c-4b28-adb0-aec77bf76044",
  "sequence": 0,
  "jwe": {
    "protected": "eyJlbmMiOiJDMjBQIn0",
    "recipients": [{
      "header": {
        "alg": "A256KW",
        "kid": "https://example.com/kms/f3ce1a43-162f-43b2-80b4-b51abbeea46e"
      },
      "encrypted_key": "OR1vdCNvf_B68mfUxFQVT-vyXVrBembuiM40mAAjDC1-Qu5iArDbug"
    }],
    "iv": "i8Nins2vTI3PlrYW",
    "ciphertext": "Cb-963UCXblINT8F6MDHzMJN9EAhK3I",
    "tag": "pfZO0JulJcrc3trOZy8rjA"
  }
}
        </pre>

        <p>
If the creation of the structured document was successful, an HTTP 201 status
code is expected in return:
        </p>

        <pre class="example highlight" title="Successful data hub creation response">
HTTP/1.1 201 Created
Location: https://example.com/data-hubs/ad800444/docs/feab3cdd-a7fe-4c43-bd2e-f0f5b49269e2
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
Date: Fri, 14 Jun 2019 18:37:12 GMT
Connection: keep-alive
Transfer-Encoding: chunked
        </pre>

      </section>

      <section class="normative">
        <h2>Reading a Document</h2>

        <p>
Reading a document from a data hub is performed by retrieving the
<a>EncryptedDocument</a> and then decrypting it to a
<a>StructuredDocument</a>. The following HTTP status codes are defined for
this service:
        </p>

        <table class="simple">
          <thead>
            <th style="white-space: nowrap">HTTP Status</th>
            <th>Description</th>
          </thead>
          <tbody>
            <tr>
              <td>200</td>
              <td>
EncryptedDocument retrieval was successful.
              </td>
            </tr>
            <tr>
              <td>400</td>
              <td>
EncryptedDocument retrieval failed.
              </td>
            </tr>
            <tr>
              <td>404</td>
              <td>
EncryptedDocument with given id was not found.
              </td>
            </tr>
          </tbody>
        </table>

        <p>
In order to convert an <a>EncryptedDocument</a> to a
<a>StructuredDocument</a> an implementer MUST decode the
<a>EncryptedDocument</a> from a JWE or a COSE Encrypted object. Once the
document is decrypted, it can be processed by the web application.
        </p>

        <p>
A protocol example of a document retrieval is shown below:
        </p>

        <pre class="example highlight" title="Data hub encrypted document retrieval">
GET https://example.com/data-hubs/ad800444/docs/feab3cdd-a7fe-4c43-bd2e-f0f5b49269e2 HTTP/1.1
Host: example.com
Accept: application/json, text/plain, */*
Accept-Encoding: gzip, deflate
        </pre>

        <p>
If the retrieval of the encrypted document was successful, an HTTP 200 status
code is expected in return:
        </p>

        <pre class="example highlight" title="Successful data hub creation response">
HTTP/1.1 200 OK
Date: Fri, 14 Jun 2019 18:37:12 GMT
Connection: keep-alive

{
  "id": "urn:uuid:94684128-c42c-4b28-adb0-aec77bf76044",
  "sequence": 0,
  "jwe": {
    "protected": "eyJlbmMiOiJDMjBQIn0",
    "recipients": [{
      "header": {
        "alg": "A256KW",
        "kid": "https://example.com/kms/f3ce1a43-162f-43b2-80b4-b51abbeea46e"
      },
      "encrypted_key": "OR1vdCNvf_B68mfUxFQVT-vyXVrBembuiM40mAAjDC1-Qu5iArDbug"
    }],
    "iv": "i8Nins2vTI3PlrYW",
    "ciphertext": "Cb-963UCXblINT8F6MDHzMJN9EAhK3I",
    "tag": "pfZO0JulJcrc3trOZy8rjA"
  }
}
        </pre>

      </section>

      <section class="normative">
        <h2>Updating a Document</h2>

        <p>
        </p>
      </section>

      <section class="normative">
        <h2>Deleting a Document</h2>

        <p>
        </p>
      </section>

      <section class="normative">
        <h2>Writing a Stream</h2>

        <p>
        </p>
      </section>

      <section class="normative">
        <h2>Reading a Stream</h2>

        <p>
        </p>
      </section>

      <section class="normative">
        <h2>Querying</h2>

        <p>
        </p>
      </section>

    </section>

  <section class="informative">
    <h2>Privacy Considerations</h2>

    <p>
This section details the general privacy considerations and specific privacy
implications of deploying this specification into production environments.
    </p>

  </section>

  <section class="informative">
    <h2>Security Considerations</h2>

    <p>
There are a number of security considerations that implementers should be
aware of when processing data described by this specification. Ignoring or
not understanding the implications of this section can result in
security vulnerabilities.
    </p>

    <p>
While this section attempts to highlight a broad set of security
considerations, it is not a complete list. Implementers are urged to seek the
advice of security and cryptography professionals when implementing mission
critical systems using the technology outlined in this specification.
    </p>

  </section>

  <section class="informative">
    <h2>Accessibility Considerations</h2>

    <p>
There are a number of accessibility considerations implementers should be
aware of when processing data described in this specification. As with any web
standards or protocols implementation, ignoring accessibility issues makes
this information unusable to a large subset of the population. It is important
to follow accessibility guidelines and standards, such as [[WCAG21]], to ensure
all people, regardless of ability, can make use of this data. This is
especially important when establishing systems utilizing cryptography, which
have historically created problems for assistive technologies.
    </p>

    <p>
This section details the general accessibility considerations to take into
account when utilizing this data model.
    </p>

  </section>

  <section class="informative">
    <h2>Internationalization Considerations</h2>

    <p>
There are a number of internationalization considerations implementers should be
aware of when publishing data described in this specification. As with any web
standards or protocols implementation, ignoring internationalization makes it
difficult for data to be produced and consumed across a disparate set of
languages and societies, which would limit the applicability of the
specification and significantly diminish its value as a standard.
    </p>

    <p>
This section outlines general internationalization considerations to take into
account when utilizing this data model.
    </p>

  </section>

  </body>
</html>
